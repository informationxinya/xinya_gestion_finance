# Supabase 数据库部署备忘录 (Database Setup Memo)

本文档归档了 **Xinya Finance** 项目所需的完整数据库 SQL 脚本。
当需要更换 Supabase 账号、重置数据库或重新部署时，请参考此文档重建数据库结构。

后期的 SQL 更新也请同步记录在此文档中。

## 1. 核心数据表 (Core Table)

请将以下 SQL 代码复制到 Supabase 的 **SQL Editor** 中运行。

```sql
-- 创建 finance_data (财务数据) 表
-- 存储所有从 Excel 导入的采购和财务记录
create table finance_data (
  id bigint generated by default as identity primary key, -- [系统自动] 唯一主键 ID，自动递增
  
  -- 基础信息
  company_name text,                                    -- [Excel] 公司名称 (供应商)
  department text,                                      -- [Excel] 部门 (如：肉部, 杂货, 菜部等)
  
  -- 发票信息
  invoice_number text,                                  -- [Excel] 发票号
  invoice_date date,                                    -- [Excel] 发票日期 (格式: YYYY-MM-DD)
  invoice_amount numeric,                               -- [Excel] 发票金额
  tps numeric,                                          -- [Excel] TPS 税额
  tvq numeric,                                          -- [Excel] TVQ 税额
  net_amount numeric,                                   -- [Excel] 税后净值
  
  -- 付款与支票信息
  check_number text,                                    -- [Excel] 付款支票号
  clear_flag text,                                      -- [Excel] 特殊标记清除 ("1" 表示清除相关支付信息)
  actual_paid_amount numeric,                           -- [Excel] 实际支付金额
  check_total_amount numeric,                           -- [Excel] 付款支票总额
  check_date date,                                      -- [Excel] 开支票日期 (即付款日期)
  check_mailed_date date,                               -- [Excel] 支票寄出日期
  
  -- 对账与备注
  bank_reconciliation_date date,                        -- [Excel] 银行对账日期
  bank_reconciliation_note text,                        -- [Excel] 银行对账备注
  difference numeric,                                   -- [Excel] 差额
  remarks text,                                         -- [Excel] 备注
  
  -- 系统字段
  created_at timestamp with time zone default timezone('utc'::text, now()) not null -- [系统自动] 创建时间
);
```

## 2. 访问权限与安全策略 (RLS Policy)

由于本项目目前在客户端进行简易的管理员验证（AdminUpload.tsx），并未集成完整的 Supabase Auth 用户系统，
因此我们需要配置一个“允许所有操作”的策略，只要请求中包含正确的 API Key (Anon Key) 即可读写数据。

```sql
-- 1. 开启表的行级安全功能 (必须开启，否则默认可能是完全开放可能不安全，或者完全关闭导致无法访问)
alter table finance_data enable row level security;

-- 2. 创建一个“允许所有”的策略
-- scope: for all (包括 select, insert, update, delete)
-- condition: using (true) (对所有行生效)
create policy "Enable all access for all users"
on finance_data
for all
using (true)
with check (true);
```

## 3. 部署后检查

确保 Supabase 项目设置中的 API Key (`anon` public key) 和 URL 是最新的，并已更新到项目的 `.env.local` 文件或 Vercel 的环境变量中。

- **Table Name**: `finance_data`
- **RLS Enabled**: Yes (Policy: "Enable all access for all users")

---
*最后更新时间: 2026-01-14*
